<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Racing</title>
</head>
<body>

	<canvas id="gameCanvas" width="800" height="600"></canvas>

	<script>
		let canvas, canvasContext;

		const carPic = document.createElement('img');
		let carPicLoaded = false;

		let carX = 75;
		let carY = 75;
		let carAng = 0;
		let carSpeed = 0;

		const TRACK_W = 40;
		const TRACK_H = 40;
		const TRACK_GAP = 2;
		const TRACK_DRAW_WIDTH = TRACK_W - TRACK_GAP;
		const TRACK_DRAW_HEIGHT = TRACK_H - TRACK_GAP;
		const TRACK_COLS = 20;
		const TRACK_ROWS = 15;
		// const trackGrid = new Array(TRACK_COLS * TRACK_ROWS);
		const trackGrid = [ 
												1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
												1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
												1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
												1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
												1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
												1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1,
												1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
												1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1,
												1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
												1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
												1, 0, 2, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
												1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
												1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
												1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
												1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
											];

		const KEY_LEFT_ARROW = 37,
					KEY_UP_ARROW = 38,
					KEY_RIGHT_ARROW = 39,
					KEY_DOWN_ARROW = 40;

		let keyHeld_Gas = false;
		let keyHeld_Reverse = false;
		let keyHeld_TurnLeft = false;
		let keyHeld_TurnRight = false;

		let mouseX = 0, mouseY = 0, trackIndexUnderMouse = 0;

		function updateMousePos(evt){
			const rect = canvas.getBoundingClientRect();
			const htmlRoot = document.documentElement;

			mouseX = evt.clientX - rect.left - htmlRoot.scrollLeft;
			mouseY = evt.clientY - rect.top - htmlRoot.scrollTop;

		}

		function carReset(){
			for(let row = 0; row < TRACK_ROWS; row++){
				for(let col = 0; col < TRACK_COLS; col++){
					const arrayIndex = rowColToArrayIndex(col, row); 
					if(trackGrid[arrayIndex] === 2){
						trackGrid[arrayIndex] = 0;
						carAng = -Math.PI/2;
						carX = col * TRACK_W;
						carY = row * TRACK_H;
					}
				}
			}
		}

		function keyPressed(evt){
			switch(evt.keyCode){
				case KEY_LEFT_ARROW:
					keyHeld_TurnLeft = true;
					break;
				case KEY_RIGHT_ARROW:
					keyHeld_TurnRight = true;
					break;
				case KEY_UP_ARROW:
					keyHeld_Gas = true;
					break;
				case KEY_DOWN_ARROW:
					console.log(evt.keyCode)
					keyHeld_Reverse = true;
					break;
			}

		}
		function keyReleased(evt){
			switch(evt.keyCode){
				case KEY_LEFT_ARROW:
					keyHeld_TurnLeft = false;
					break;
				case KEY_RIGHT_ARROW:
					keyHeld_TurnRight = false;
					break;
				case KEY_UP_ARROW:
					keyHeld_Gas = false;
					break;
				case KEY_DOWN_ARROW:
					keyHeld_Reverse = false;
					break;
			}
		}

		window.onload = function() {
			canvas = document.getElementById('gameCanvas');
			canvasContext = canvas.getContext('2d');

			const framesPerSecond = 30;
			const framesUpdateInterval = 1000 / framesPerSecond;
			setInterval(updateAll, framesUpdateInterval);

			canvas.addEventListener('mousemove', updateMousePos)

			document.addEventListener('keydown', keyPressed);
			document.addEventListener('keyup', keyReleased);

			carPic.onload = () => carPicLoaded = true;
			carPic.src = "player1car.png";

			carReset();
		}

		function updateAll(){
			moveAll();
			drawAll();
		}

		function carMove(){
			carSpeed *= 0.97;

			if(keyHeld_Gas) carSpeed += 0.08;
			if(keyHeld_Reverse) carSpeed -= 0.08;
			if(keyHeld_TurnLeft) carAng -= 0.04;
			if(keyHeld_TurnRight) carAng += 0.04;

			carX += Math.cos(carAng) * carSpeed;
			carY += Math.sin(carAng) * carSpeed;
		}

		function isTrackAtColRow(col, row){
			if( col >= 0 && col < TRACK_COLS &&
					row >= 0 && row < TRACK_ROWS){
				const trackIndexUnderCoord = rowColToArrayIndex(col, row);
				return (trackGrid[trackIndexUnderCoord] === 1);
			}
			return false;
		}

		function carTrackHandling(){
			const carTrackCol = Math.floor(carX / TRACK_W);
			const carTrackRow = Math.floor(carY / TRACK_H);
			const trackIndexUnderCar = rowColToArrayIndex(carTrackCol, carTrackRow);

			if( 
					carTrackCol >= 0 && carTrackCol < TRACK_COLS &&
					carTrackRow >= 0 && carTrackRow < TRACK_ROWS
				 ){
				if(isTrackAtColRow(carTrackCol, carTrackRow)){
					carX -= Math.cos(carAng) * carSpeed;
					carY -= Math.sin(carAng) * carSpeed;
					carSpeed *= -0.5

				} // end of track found
			} // end of valid col and row
		} 

		
		function moveAll(){
			carMove();
			carTrackHandling();
		}

		function rowColToArrayIndex(col, row){
			return col + TRACK_COLS * row;
		}

		function drawTracks(){
			for(let row = 0; row < TRACK_ROWS; row++){
				for(let col = 0; col < TRACK_COLS; col++){
					const arrayIndex = rowColToArrayIndex(col, row); 
					if(trackGrid[arrayIndex] === 1){
						colorRect(TRACK_W*col,TRACK_H*row, TRACK_DRAW_WIDTH,TRACK_DRAW_HEIGHT, 'blue')
					}
				}
			}
		}

		function drawAll(){
			
			colorRect(0,0, canvas.width,canvas.height, 'black'); // clear screen
			// colorCircle(carX,carY, 10, 'white'); // draw car
			canvasContext.fill();

			if(carPicLoaded) drawBitmapCenteredWithRotation(carPic, carX,carY, carAng);

			drawTracks();


		}

		function drawBitmapCenteredWithRotation(useBitmap, atX,atY, withAng){
			canvasContext.save();
			canvasContext. translate(atX, atY);
			canvasContext.rotate(withAng);
			canvasContext.drawImage(useBitmap, -useBitmap.width/2,-useBitmap.height/2 );
			canvasContext.restore();
		}

		function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor){
			canvasContext.fillStyle = fillColor;
			canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
		}

		function colorCircle(centerX,centerY, radius, fillColor){
			canvasContext.fillStyle = fillColor;
			canvasContext.beginPath();
			canvasContext.arc(centerX,centerY, radius, 0, Math.PI*2, true); // cx, cy, radius, from 0 to 360 deg, clockwise
		}

		function colorText(showWords, textX,textY, fillColor){
			canvasContext.fillStyle = fillColor;
			canvasContext.fillText(showWords, textX,textY);
		}

	</script>
</body>
</html>
